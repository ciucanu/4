#!/bin/bash

set -e

# Log levels
INFO="[INFO]"
ERROR="[ERROR]"
DEBUG="[DEBUG]"

# Get the current date for log filename
LOG_DATE=$(date '+%Y-%m-%d')
LOG_FILE="/tmp/sql_$LOG_DATE.log"

# Function to log messages
log_message() {
    local level="$1"
    shift
    local message="$@"
    # Log to both console and file
    echo "$(date '+%Y-%m-%d %H:%M:%S') $level $message" | tee -a "$LOG_FILE"
}

# Function to get password using eva.sh script
get_password() {
    EVA_PATH="$1"
    password=$(~/.eva/eva.sh "$EVA_PATH" -s)
    echo "$password"
}

# Function to execute SQL files
execute_sql() {
    SQL_FILE="$1"
    PG_CONNECTION="$2"
    PASSWORD="$3"

    log_message "$INFO" "Executing SQL file: $SQL_FILE on connection: $PG_CONNECTION"

    # Use PGPASSWORD environment variable to pass password securely and capture output with tee
    PGPASSWORD="$PASSWORD" psql "$PG_CONNECTION" -c "\\i $SQL_FILE" 2>&1 | tee -a "$LOG_FILE"

    if [ ${PIPESTATUS[0]} -ne 0 ]; then
        log_message "$ERROR" "Failed to execute SQL file: $SQL_FILE"
    else
        log_message "$INFO" "Successfully executed SQL file: $SQL_FILE"
    fi
}

# Corrected Function to download a file
download_file() {
    URL="$1"
    OUTPUT="$2"

    log_message "$INFO"​⬤
